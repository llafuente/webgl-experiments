<!DOCTYPE html>
<html lang="en">
    <head>
        <title>three.js canvas - geometry - cube</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <style>
            body {
                font-family: Monospace;
                background-color: #e0e0e0;
                margin: 0px;
                overflow: hidden;
            }
            canvas {
                border: 1px solid black;
            }
            #tools img {
                border: 1px solid white;
                border-radius: 4px;
            }
            #tools .selected {
                border: 1px solid black;
            }
        </style>
        <script src="EventEmitter.js"></script>
        <script src="jquery-2.1.1.js"></script>
        <script src="three.js"></script>
        <script src="app.js"></script>
        <script src="utils.js"></script>

        <script src="controls/FlyControls.js"></script>
        <script src="controls/OrbitControls.js"></script>
        <script src="controls/OrthographicTrackballControls.js"></script>

        <script src="libs/stats.min.js"></script>

        <script data-src="shaders/vertex.js" type="x-shader/x-vertex" id="vertexshader"></script>
        <script data-src="shaders/fragment.js" type="x-shader/x-fragment" id="fragmentshader"></script>

    </head>

    <body>
        <div style="width:64px; position: absolute; right: 0;" id="tools">
            <img id="tool-camera" class="selected" src="images/1409329287_film_camera_16mm.png" />
            <img id="tool-move" src="images/1409329351_move_alt1-64.png" />
            <img id="tool-push" src="images/1409329490_arrow_up_alt1-64.png" />
            <img id="tool-pull" src="images/1409329484_arrow_down_alt1-64.png" />
        </div>
    </body>

<script>
"use strict";

// http://jsfiddle.net/4Txgp/13/

function mark (position) {
    var geometry = new THREE.BoxGeometry(50, 50, 50);
    var material = new THREE.MeshPhongMaterial({color: 0xff0000});
    var cube = new THREE.Mesh(geometry, material);
    cube.position.x = position.x;
    cube.position.y = position.y;
    cube.position.z = position.z;
    this.scene.add(cube);
}

var camera2,
    uniforms,
    TPMaterial;

function createTPMaterial() {
    camera2 = new THREE.OrthographicCamera(-1, 1, 1, -1, 1, 100.0);
    camera2.position.x = 0;
    camera2.position.y = 10;
    camera2.position.z = 0;
    camera2.lookAt(new THREE.Vector3());
    camera2.updateProjectionMatrix();

    uniforms = THREE.UniformsUtils.merge([THREE.UniformsLib.lights, {
      time: { type:"f", value:0 },
      resolution: { type:"v2", value:new THREE.Vector2(viewportWidth, viewportHeight) },
      projectorWorldViewProjTransform: {type: "m4", value: null}
    }]);

    // do not include tex0 above it fails
    uniforms.tex0 = { type:"t", value: THREE.ImageUtils.loadTexture("mi2-3.gif") }
    uniforms.tex0.value.wrapS = uniforms.tex0.value.wrapT = THREE.Repeat;

    TPMaterial = new THREE.ShaderMaterial({
      uniforms: uniforms,
      vertexShader: shaders.vertexshader,
      fragmentShader: shaders.fragmentshader,
      lights: true
    });
}

var app = new App();

app.createScene = function() {
    //this.cameras[0].debug();
    //this.cameras[1].debug();
    //this.cameras[2].debug();

    this.scene.add(new THREE.AmbientLight(0xffffff));

/*
    // LIGHTS

    var light = new THREE.SpotLight(0xffffff, 1, 0, Math.PI / 2, 1);
    light.position.set(0, 1500, 0);
    light.target.position.set(0, 0, 0);

    light.castShadow = true;

    light.shadowCameraNear = 120;
    light.shadowCameraFar = 25000;
    light.shadowCameraFov = 50;

    //light.shadowCameraVisible = true;

    light.shadowBias = 0.0001;
    light.shadowDarkness = 0.5;

    light.shadowMapWidth = 1024;
    light.shadowMapHeight = 1024;

    this.scene.add(light);

    //mark(light.position);

    // Cubes
    var pixels = image_to_pixels(image, document.getElementById("ref-image-depth")),
        width = image.width,
        height = image.height,
        count = 0,
        box_size = 7;

    for (var i = 0; i < pixels.length; i += 4) {
        if (pixels[i] !== undefined) {
            var box_width = (pixels[i] + pixels[i+1] + pixels[i+2]) / 3 / 50;
            var geometry = new THREE.BoxGeometry(box_size, box_size, box_size * box_width);

            for (var j = 0; j < geometry.faces.length; ++j) {
                geometry.faces[ j ].color.setRGB(pixels[i] / 255, pixels[i+1] / 255, pixels[i+2] / 255);
            }
            var material = new THREE.MeshBasicMaterial({ vertexColors: THREE.FaceColors, overdraw: 0.5 });

            //var material = new THREE.MeshLambertMaterial({color: (pixels[i]) << 16 ^ (pixels[i+1] * 255) << 8 ^ (pixels[i+2] * 255) << 0, specular: 0xffffff, ambient: 0x000000 });
            //var material = new THREE.MeshPhongMaterial({color: (pixels[i]) << 16 ^ (pixels[i+1] * 255) << 8 ^ (pixels[i+2] * 255) << 0, specular: 0xffffff, ambient: 0x000000 });

            var cube = new THREE.Mesh(geometry, material);
            cube.castShadow = true;
            cube.receiveShadow = true;


            cube.position.x = (count % width) * box_size;
            cube.position.y = Math.floor(height - count / width) * box_size;
            //cube.position.x = (count % 20) * box_size;
            //cube.position.y = Math.floor(count / 20) * box_size;
            this.scene.add(cube);

        }
        ++count;
    }

    // Plane

    var geometry = new THREE.BoxGeometry(10, 10, 10);

    //var material = new THREE.MeshBasicMaterial({ color: 0xe0e0e0, overdraw: 0.5 });
    //var material = new THREE.MeshPhongMaterial({ color: 0xe0e0e0 });
    var material = new THREE.MeshPhongMaterial({ color: 0xff0000 });
    material.ambient = material.color;

    var box = new THREE.Mesh(geometry, material);
    this.scene.add(box);

    */
    var material = new THREE.MeshPhongMaterial({
        color: 0xffff00,
        wireframe: true,
    });
    material.ambient = material.color;
    var geometry = new THREE.PlaneGeometry(100, 100, 100, 100);
    geometry.applyMatrix(
        new THREE.Matrix4().makeRotationY(Math.PI)
    );

    geometry.dynamic = true;

    this.on("mousedown", function(event) {
        if (app.lastSelectedCamera == app.cameras[2]) {

            var idx = event.cameraX +  event.cameraY * 200;

            console.log(idx, "pull!");

            // edit geometry

            geometry.verticesNeedUpdate = true;

            geometry.vertices[idx].z += 20;
        }
    })

    var plane = new THREE.Mesh(geometry, material);

    plane.castShadow = false;
    plane.receiveShadow = true;
    plane.position.y = -0;
    this.scene.add(plane);


    this.displayAxes();
};

$(document).ready(function() {
    app.init({
        width: 400 || window.innerWidth,
        height: 400 || window.innerHeight,
        images: ["images/mi2-jail.gif"],
        cameras: [{
            id: "isometric",
            background: 0xdddddd,
            // screen position, based on this will calculate real world size camera for you
            top: 1,
            bottom: 0.5,
            left: 0,
            right: 0.5,
            position: {x: 500, y: 500, z: 500},
            lookAt: {x: 0, y: 0, z:0}
        },{
            id: "isometric2",
            background: 0xeeeeee,
            top: 1,
            bottom: 0.5,
            left: 0.5,
            right: 1,
            position: {x: 1000, y: 1000, z: -1000},
            lookAt: {x: 0, y: 0, z: 0}
        },{
            id: "front",
            background: 0xdddddd,
            top: 0.5,
            bottom: 0,
            left: 0,
            right: 0.5,
            position: {x: 0, y: 0, z: 1000},
            lookAt: {x: 0, y: 0, z: 0},
            aspectRatio: 5
        },{
            id: "top",
            background: 0xeeeeee,
            top: 0.5,
            bottom: 0,
            left: 0.5,
            right: 1,
            position: {x: 0, y: 1000, z: 0},
            lookAt: {x: 0, y: 0, z: 0}
        }]
    });

    app.start();

    var projectorWorldViewProj = new THREE.Matrix4();

    app.on("frameStart", function() {
        camera2.position.x += 0.01;
        //camera2.position.y += 0.01;
        camera2.lookAt(new THREE.Vector3(0, 0, 0));

        projectorWorldViewProj.set( 0.5, 0.0, 0.0, 0.5,
                  0.0, 0.5, 0.0, 0.5,
                  0.0, 0.0, 0.5, 0.5,
                  0.0, 0.0, 0.0, 1.0 );

        projectorWorldViewProj.copy(camera2.matrix);
        projectorWorldViewProj.copy(camera2.matrixWorldInverse);

        //projectorWorldViewProj.multiply( camera2.projectionMatrix );
        //projectorWorldViewProj.multiply( camera2.matrixWorldInverse );
        //projectorWorldViewProj.multiply( camera2.matrix );


        uniforms.projectorWorldViewProjTransform.value = projectorWorldViewProj;
        console.log(JSON.stringify(projectorWorldViewProj.elements));

    })
});

</script>








